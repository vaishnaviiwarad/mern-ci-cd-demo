# name: MERN CI Pipeline

# on:
#   push:
#     branches: ["main", "feature"]
#   pull_request:
#     branches: ["main", "feature"]

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v3

#       - name: Setup Node.js
#         uses: actions/setup-node@v3
#         with:
#           node-version: 22

#       - name: Setup pnpm
#         uses: pnpm/action-setup@v2
#         with:
#           version: 10

#       - name: Verify pnpm
#         run: pnpm -v

#       - name: Install Frontend Dependencies
#         working-directory: ./myapp
#         run: pnpm install --frozen-lockfile

#       - name: Lint Frontend
#         working-directory: ./myapp
#         run: pnpm lint || exit 1

#       - name: Build Frontend
#         working-directory: ./myapp
#         run: pnpm run build

#       - name: Install Backend Dependencies
#         working-directory: ./backend
#         run: pnpm install --frozen-lockfile

#       - name: Lint Backend
#         working-directory: ./backend
#         run: pnpm lint || exit 1

#       - name: Run Backend Tests (optional)
#         working-directory: ./backend
#         run: pnpm test || echo "No backend tests"

#       - name: Run Backend (runtime check)
#         working-directory: ./backend
#         run: node index.js


name: MERN CI Pipeline

on:
  push:
    branches: ["main", "feature"]
  pull_request:
    branches: ["main", "feature"]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: 'pnpm'

      # Step 3: Setup pnpm
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      # Step 4: Verify pnpm
      - name: Verify pnpm
        run: pnpm -v

      # FRONTEND STEPS
      # Step 5: Install Frontend Dependencies
      - name: Install Frontend Dependencies
        working-directory: ./myapp
        run: pnpm install --frozen-lockfile

      # Step 6: Lint Frontend
      - name: Lint Frontend
        working-directory: ./myapp
        run: pnpm lint || exit 1

      # Step 7: Build Frontend
      - name: Build Frontend
        working-directory: ./myapp
        run: pnpm run build

      # BACKEND STEPS  
      # Step 8: Install Backend Dependencies
      - name: Install Backend Dependencies
        working-directory: ./backend
        run: pnpm install --frozen-lockfile

      # Step 9: Lint Backend
      - name: Lint Backend
        working-directory: ./backend
        run: pnpm lint || exit 1

      # Step 10: Run Backend Tests
      - name: Run Backend Tests
        working-directory: ./backend
        run: pnpm test || echo "Backend tests completed"

      # Step 11: Runtime Check (FIXED)
      - name: Run Backend (runtime check)
        working-directory: ./backend
        run: |
          # Start server in background
          echo "Starting server..."
          node index.js &
          SERVER_PID=$!
          
          # Wait for server to start
          echo "Waiting for server to start..."
          sleep 10
          
          # Check if server process is running
          if ps -p $SERVER_PID > /dev/null; then
            echo "✅ Server is running (PID: $SERVER_PID)"
            
            # Try to check if port is open
            if nc -z localhost 3080; then
              echo "✅ Server is listening on port 3080"
            else
              echo "⚠️  Server running but port 3080 not accessible"
            fi
            
            # Kill the server
            echo "Stopping server..."
            kill $SERVER_PID
            wait $SERVER_PID 2>/dev/null
            echo "✅ Server stopped successfully"
            exit 0
          else
            echo "❌ Server failed to start"
            exit 1
          fi